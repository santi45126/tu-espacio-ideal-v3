const departmentGrid=document.querySelector(".department-grid"),searchInput=document.getElementById("search-input"),searchButton=document.getElementById("search-button"),clearSearchButton=document.getElementById("clear-search-button"),publishButton=document.getElementById("publish-button"),minBedroomsSelect=document.getElementById("min-bedrooms"),minPriceInput=document.getElementById("min-price"),maxPriceInput=document.getElementById("max-price"),sortBySelect=document.getElementById("sort-by"),modalPublish=document.getElementById("modal-publish"),modalDetails=document.getElementById("modal-details"),closeButtons=document.querySelectorAll(".close-button"),publishForm=document.getElementById("publish-form"),modalPublishTitle=document.getElementById("modal-publish-title"),imageUpload=document.getElementById("image_upload"),imagePreview=document.getElementById("image-preview"),imageUrlUnchanged=document.getElementById("image-url-unchanged"),contactToggleButton=document.querySelector(".contact-toggle-button"),contactFormContainer=document.getElementById("contact-form-container"),contactForm=document.getElementById("contact-form"),paginationControls=document.getElementById("pagination-controls"),userActionButton=document.getElementById("user-action-button"),modalAuth=document.getElementById("modal-auth"),authForm=document.getElementById("auth-form"),authToggleLink=document.getElementById("auth-toggle-link"),authTitle=document.getElementById("auth-title"),authNameGroup=document.getElementById("auth-name-group"),logoutButton=document.getElementById("logout-button"),userNameDisplay=document.getElementById("user-name-display"),userEmailDisplay=document.getElementById("user-email-display");let currentPage=1;const itemsPerPage=6;let totalDepartmentsCount=0,allDepartments=[],editingDepartmentId=null,currentSearchTerm="",currentUser=null;function showToast(e,t="success"){var n=document.getElementById("toast-container");const a=document.createElement("div");a.classList.add("toast",t),a.textContent=e,n.appendChild(a),setTimeout(()=>{a.remove()},3e3)}function openModal(e){e.style.display="block",setTimeout(()=>e.classList.add("show"),10)}function closeModal(e){e.classList.remove("show"),setTimeout(()=>e.style.display="none",300),e===modalDetails&&(contactFormContainer.style.display="none",contactForm.reset())}async function loadDepartments(e=1,t=!1){currentPage=e;try{var n=window.collection(window.db,"departamentos");let e;e=t&&currentUser&&currentUser.uid?window.query(n,window.where("userId","==",currentUser.uid)):n;var a=await window.getDocs(e);const o=[];a.forEach(e=>{o.push({id:e.id,...e.data()})}),totalDepartmentsCount=o.length,allDepartments=o,filterAndSortDepartments(t)}catch(e){console.error("Error al cargar los departamentos desde Firebase:",e),showToast("Error al cargar departamentos. Intente de nuevo más tarde.","error")}}function highlightText(e,t){return t&&null!=e?(t=new RegExp(`(${t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi"),e.replace(t,'<span class="highlight">$1</span>')):e}function displayDepartments(e){departmentGrid.innerHTML="",0===e.length&&(departmentGrid.innerHTML="<p>No se encontraron departamentos que coincidan con la búsqueda.</p>"),e.forEach(e=>{var t=document.createElement("div"),n=(t.classList.add("department-card"),highlightText(e.title,currentSearchTerm)),a=highlightText(e.location,currentSearchTerm),o=highlightText(e.description,currentSearchTerm);t.innerHTML=`
            <img src="${e.image_url||"https://placehold.co/300x200/cccccc/FFFFFF?text=Imagen+No+Disponible"}" alt="Imagen del departamento en ${e.location||"Desconocida"}" onerror="this.onerror=null;this.src='https://placehold.co/300x200/cccccc/FFFFFF?text=Error+al+cargar+imagen';" loading="lazy">
            <h3>${n||"Departamento sin título"}</h3>
            <p><strong>Ubicación:</strong> ${a||"Desconocida"}</p>
            <p><strong>Precio:</strong> $${(e.price||0).toLocaleString("es-AR")}</p>
            <p><strong>Habitaciones:</strong> ${e.bedrooms||"N/A"}</p>
            <p><strong>Baños:</strong> ${e.bathrooms||"N/A"}</p>
            <p><strong>Descripción:</strong> ${o||"Sin descripción."}</p>
            <button class="details-button" data-id="${e.id}">Ver Detalles</button>
            ${currentUser&&e.userId===currentUser.uid?`<button class="edit-button" data-id="${e.id}">Editar</button>
                 <button class="delete-button" data-id="${e.id}">Eliminar</button>`:""}
        `,departmentGrid.appendChild(t)}),document.querySelectorAll(".details-button").forEach(e=>{e.addEventListener("click",e=>showDepartmentDetails(e.target.dataset.id))}),document.querySelectorAll(".edit-button").forEach(e=>{e.addEventListener("click",e=>editDepartment(e.target.dataset.id))}),document.querySelectorAll(".delete-button").forEach(e=>{e.addEventListener("click",e=>deleteDepartment(e.target.dataset.id))}),renderPaginationControls()}function showDepartmentDetails(t){var e=allDepartments.find(e=>e.id===t);e&&(document.getElementById("department-title").textContent=e.title||"Detalles del Departamento",document.getElementById("department-image").src=e.image_url||"https://placehold.co/300x200/cccccc/FFFFFF?text=Imagen+No+Disponible",document.getElementById("department-image").alt="Imagen del departamento en "+(e.location||"Desconocida"),document.getElementById("department-location").textContent=e.location||"Desconocida",document.getElementById("department-price").textContent=(e.price||0).toLocaleString("es-AR"),document.getElementById("department-bedrooms").textContent=e.bedrooms||"N/A",document.getElementById("department-bathrooms").textContent=e.bathrooms||"N/A",document.getElementById("department-description").textContent=e.description||"Sin descripción.",contactFormContainer.style.display="none",contactForm.reset(),openModal(modalDetails))}async function saveDepartment(e,t){if(currentUser){e.userId=currentUser.uid;try{var n,a,o,r;t?(n=window.ref(window.storage,`images/departments/${Date.now()}_`+t.name),a=await window.uploadBytes(n,t),e.image_url=await window.getDownloadURL(a.ref)):editingDepartmentId&&"true"===imageUrlUnchanged.value?(o=allDepartments.find(e=>e.id===editingDepartmentId),e.image_url=o?o.image_url:null):e.image_url=null,editingDepartmentId?(r=window.doc(window.db,"departamentos",editingDepartmentId),await window.updateDoc(r,e),showToast("Departamento actualizado con éxito.")):(await window.addDoc(window.collection(window.db,"departamentos"),e),showToast("Departamento publicado con éxito.")),closeModal(modalPublish),loadDepartments(currentPage,"my-listings"===userActionButton.dataset.view)}catch(e){console.error("Error al guardar el departamento en Firebase:",e),showToast("Error al guardar el departamento. Intente de nuevo.","error")}}else showToast("Debes iniciar sesión para publicar/editar un departamento.","error")}async function deleteDepartment(t){if(confirm("¿Estás seguro de que quieres eliminar este departamento?"))if(currentUser)try{var e=window.doc(window.db,"departamentos",t),n=allDepartments.find(e=>e.id===t);n&&n.userId!==currentUser.uid?showToast("No tienes permiso para eliminar este departamento.","error"):(await window.deleteDoc(e),showToast("Departamento eliminado con éxito.","info"),loadDepartments(currentPage,"my-listings"===userActionButton.dataset.view))}catch(e){console.error("Error al eliminar el departamento de Firebase:",e),showToast("Error al eliminar el departamento.","error")}else showToast("Necesitas iniciar sesión para eliminar departamentos.","error")}async function editDepartment(t){var e=allDepartments.find(e=>e.id===t);e&&(currentUser&&e.userId===currentUser.uid?(modalPublishTitle.textContent="Editar Departamento",document.getElementById("title").value=e.title||"",document.getElementById("location").value=e.location||"",document.getElementById("contact").value=e.contact||"",document.getElementById("price").value=e.price||"",document.getElementById("bedrooms").value=e.bedrooms||"",document.getElementById("bathrooms").value=e.bathrooms||"",document.getElementById("description").value=e.description||"",imagePreview.src=e.image_url||"https://placehold.co/300x200/cccccc/FFFFFF?text=Sin+Imagen",imageUrlUnchanged.value="true",editingDepartmentId=t,openModal(modalPublish)):showToast("No tienes permiso para editar este departamento.","error"))}function filterAndSortDepartments(r=!1){const i=currentSearchTerm=searchInput.value.toLowerCase().trim(),s=parseInt(minBedroomsSelect.value),l=parseFloat(minPriceInput.value),d=parseFloat(maxPriceInput.value);var e=allDepartments.filter(e=>{var t=""===i||e.title&&e.title.toLowerCase().includes(i)||e.location&&e.location.toLowerCase().includes(i)||e.description&&e.description.toLowerCase().includes(i),n=0===s||e.bedrooms&&e.bedrooms>=s,a=isNaN(l)||e.price&&e.price>=l,o=isNaN(d)||e.price&&e.price<=d,e=!r||e.userId===(currentUser?currentUser.uid:null);return t&&n&&a&&o&&e});const o=sortBySelect.value;"none"!==o&&e.sort((e,t)=>{let n,a;return o.includes("price")?(n=e.price||0,a=t.price||0):o.includes("bedrooms")&&(n=e.bedrooms||0,a=t.bedrooms||0),o.endsWith("asc")?n-a:a-n}),displayDepartments(e)}function renderPaginationControls(){var e=Math.ceil(totalDepartmentsCount/itemsPerPage);if(paginationControls.innerHTML="",0===allDepartments.length&&(""===currentSearchTerm||currentUser&&"my-listings"===userActionButton.dataset.view))paginationControls.style.display="none";else{paginationControls.style.display="flex";var n=document.createElement("button");n.textContent="Anterior",n.classList.add("pagination-button"),n.disabled=1===currentPage,n.addEventListener("click",()=>goToPage(currentPage-1)),paginationControls.appendChild(n);let t=Math.max(1,currentPage-Math.floor(2.5));var a=Math.min(e,t+5-1);for(let e=t=a-t+1<5?Math.max(1,a-5+1):t;e<=a;e++){var o=document.createElement("button");o.textContent=e,o.classList.add("pagination-button"),e===currentPage&&o.classList.add("active"),o.addEventListener("click",()=>goToPage(e)),paginationControls.appendChild(o)}n=document.createElement("button");n.textContent="Siguiente",n.classList.add("pagination-button"),n.disabled=currentPage===e||0===e,n.addEventListener("click",()=>goToPage(currentPage+1)),paginationControls.appendChild(n)}}function goToPage(e){var t=currentUser&&"my-listings"===userActionButton.dataset.view;loadDepartments(currentPage=e,t)}function updateUserUI(){currentUser?(userActionButton.textContent=`Hola, ${currentUser.displayName||currentUser.email} (Mis Publicaciones)`,userNameDisplay.textContent=currentUser.displayName||"",userEmailDisplay.textContent=currentUser.email||"",publishButton.style.display="block",logoutButton.style.display="block"):(userActionButton.textContent="Iniciar Sesión / Registrarse",userNameDisplay.textContent="",userEmailDisplay.textContent="",publishButton.style.display="none",logoutButton.style.display="none"),currentUser||"my-listings"!==userActionButton.dataset.view||(userActionButton.dataset.view="all")}function logout(){window.signOut(window.auth).then(()=>{showToast("Sesión cerrada correctamente.","info")}).catch(e=>{console.error("Error al cerrar sesión:",e),showToast("Error al cerrar sesión.","error")})}imageUpload.addEventListener("change",function(){var e,t=this.files[0];t?((e=new FileReader).onload=function(e){imagePreview.src=e.target.result,imageUrlUnchanged.value="false"},e.readAsDataURL(t)):(imagePreview.src="https://placehold.co/300x200/cccccc/FFFFFF?text=Sin+Imagen",imageUrlUnchanged.value="true")}),closeButtons.forEach(e=>{e.addEventListener("click",()=>{closeModal(modalPublish),closeModal(modalDetails),closeModal(modalAuth)})}),window.addEventListener("click",e=>{e.target===modalPublish&&closeModal(modalPublish),e.target===modalDetails&&closeModal(modalDetails),e.target===modalAuth&&closeModal(modalAuth)}),publishButton.addEventListener("click",()=>{currentUser?(modalPublishTitle.textContent="Publicar Nuevo Departamento",publishForm.reset(),imagePreview.src="https://placehold.co/300x200/cccccc/FFFFFF?text=Sin+Imagen",imageUrlUnchanged.value="true",editingDepartmentId=null,openModal(modalPublish)):(showToast("Necesitas iniciar sesión para publicar un departamento.","info"),openModal(modalAuth),authTitle.textContent="Inicia Sesión o Regístrate para Publicar",authNameGroup.style.display="none",authForm.dataset.mode="login",authToggleLink.textContent="¿No tienes una cuenta? Regístrate aquí.")}),searchButton.addEventListener("click",()=>{loadDepartments(currentPage=1,"my-listings"===userActionButton.dataset.view)}),searchInput.addEventListener("keyup",e=>{"Enter"===e.key&&loadDepartments(currentPage=1,"my-listings"===userActionButton.dataset.view)}),minBedroomsSelect.addEventListener("change",()=>{loadDepartments(currentPage=1,"my-listings"===userActionButton.dataset.view)}),minPriceInput.addEventListener("input",()=>{loadDepartments(currentPage=1,"my-listings"===userActionButton.dataset.view)}),maxPriceInput.addEventListener("input",()=>{loadDepartments(currentPage=1,"my-listings"===userActionButton.dataset.view)}),sortBySelect.addEventListener("change",()=>{filterAndSortDepartments("my-listings"===userActionButton.dataset.view)}),clearSearchButton.addEventListener("click",()=>{searchInput.value="",minBedroomsSelect.value="0",minPriceInput.value="",maxPriceInput.value="",sortBySelect.value="none",currentSearchTerm="",loadDepartments(currentPage=1,"my-listings"===userActionButton.dataset.view)}),publishForm.addEventListener("submit",async e=>{e.preventDefault();e=new FormData(publishForm),e={title:e.get("title"),location:e.get("location"),contact:e.get("contact"),price:parseFloat(e.get("price")),bedrooms:parseInt(e.get("bedrooms")),bathrooms:parseFloat(e.get("bathrooms")),description:e.get("description"),createdAt:new Date};e.title&&""!==e.title.trim()?e.location&&""!==e.location.trim()?e.contact&&""!==e.contact.trim()?isNaN(e.price)||e.price<=0?showToast("El precio debe ser un número positivo.","error"):isNaN(e.bedrooms)||e.bedrooms<=0||!Number.isInteger(e.bedrooms)?showToast("Las habitaciones deben ser un número entero positivo.","error"):isNaN(e.bathrooms)||e.bathrooms<=0?showToast("Los baños deben ser un número positivo.","error"):/^[^\s@]+@[^\s@]+\.[^\s@]+$|^[0-9\s\-\(\)\+]{7,}$/.test(e.contact)?await saveDepartment(e,0<imageUpload.files.length&&"false"===imageUrlUnchanged.value?imageUpload.files[0]:null):showToast("Formato de contacto inválido. Ingrese un email o un número de teléfono válido (mín. 7 dígitos).","error"):showToast("El contacto es obligatorio.","error"):showToast("La ubicación es obligatoria.","error"):showToast("El título es obligatorio.","error")}),contactToggleButton.addEventListener("click",()=>{contactFormContainer.style.display="none"===contactFormContainer.style.display?"block":"none"}),contactForm.addEventListener("submit",async e=>{e.preventDefault();var e=document.getElementById("inquirer-name").value.trim(),t=document.getElementById("inquirer-email").value.trim(),n=document.getElementById("inquirer-phone").value.trim(),a=document.getElementById("inquirer-message").value.trim();e?t&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)?a?(showToast("Consulta enviada con éxito. El publicador se contactará pronto.","success"),console.log("Consulta enviada:",{departmentTitle:document.getElementById("department-title").textContent,inquirerName:e,inquirerEmail:t,inquirerPhone:n,inquirerMessage:a}),contactForm.reset(),contactFormContainer.style.display="none"):showToast("El mensaje no puede estar vacío.","error"):showToast("Por favor, ingresa un email válido.","error"):showToast("Por favor, ingresa tu nombre.","error")}),window.onAuthStateChanged(window.auth,e=>{currentUser=e,updateUserUI(),loadDepartments(currentPage,"my-listings"===userActionButton.dataset.view)}),userActionButton.addEventListener("click",()=>{currentUser?"all"===userActionButton.dataset.view?(userActionButton.dataset.view="my-listings",userActionButton.textContent=`Hola, ${currentUser.displayName||currentUser.email} (Todas las Publicaciones)`,loadDepartments(1,!0)):(userActionButton.dataset.view="all",userActionButton.textContent=`Hola, ${currentUser.displayName||currentUser.email} (Mis Publicaciones)`,loadDepartments(1,!1)):(authTitle.textContent="Inicia Sesión o Regístrate",authNameGroup.style.display="block",authForm.dataset.mode="register",authToggleLink.textContent="¿Ya tienes una cuenta? Inicia Sesión aquí.",openModal(modalAuth))}),authForm.addEventListener("submit",async e=>{e.preventDefault();var e=document.getElementById("auth-email").value.trim(),t=document.getElementById("auth-password").value.trim(),n=document.getElementById("auth-name").value.trim(),a=authForm.dataset.mode;if(e&&t)if(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e))if(t.length<6)showToast("La contraseña debe tener al menos 6 caracteres.","error");else try{if("register"===a){if(!n)return void showToast("El nombre es obligatorio para registrarse.","error");var o=await window.createUserWithEmailAndPassword(window.auth,e,t);await window.updateProfile(o.user,{displayName:n}),showToast(`Bienvenido, ${n}! Te has registrado exitosamente.`,"success")}else await window.signInWithEmailAndPassword(window.auth,e,t),showToast("Bienvenido de nuevo!","success");closeModal(modalAuth)}catch(e){console.error("Error de autenticación:",e.code,e.message);let t="Error de autenticación. Intente de nuevo.";"auth/email-already-in-use"===e.code?t="Este email ya está registrado.":"auth/invalid-email"===e.code?t="Email inválido.":"auth/user-not-found"===e.code||"auth/wrong-password"===e.code?t="Email o contraseña incorrectos.":"auth/weak-password"===e.code&&(t="La contraseña es demasiado débil (mínimo 6 caracteres)."),showToast(t,"error")}else showToast("Por favor, ingresa un email válido.","error");else showToast("El email y la contraseña son obligatorios.","error")}),authToggleLink.addEventListener("click",e=>{e.preventDefault(),"register"===authForm.dataset.mode?(authForm.dataset.mode="login",authTitle.textContent="Iniciar Sesión",authNameGroup.style.display="none",authToggleLink.textContent="¿No tienes una cuenta? Regístrate aquí."):(authForm.dataset.mode="register",authTitle.textContent="Registrarse",authNameGroup.style.display="block",authToggleLink.textContent="¿Ya tienes una cuenta? Inicia Sesión aquí."),authForm.reset()}),logoutButton.addEventListener("click",logout);