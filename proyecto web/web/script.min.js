const API_BASE_URL='https://667b2184bd04576b61ee483c.mockapi.io';const API_ENDPOINT='/departments';const departmentGrid=document.querySelector('.department-grid');const searchInput=document.getElementById('search-input');const searchButton=document.getElementById('search-button');const clearSearchButton=document.getElementById('clear-search-button');const publishButton=document.getElementById('publish-button');const minBedroomsSelect=document.getElementById('min-bedrooms');const minPriceInput=document.getElementById('min-price');const maxPriceInput=document.getElementById('max-price');
// --- NUEVO: Selector de Ordenamiento ---
const sortBySelect=document.getElementById('sort-by');
// --- FIN NUEVO: Selector de Ordenamiento ---
const modalPublish=document.getElementById('modal-publish');const modalDetails=document.getElementById('modal-details');const closeButtons=document.querySelectorAll('.close-button');const publishForm=document.getElementById('publish-form');const modalPublishTitle=document.getElementById('modal-publish-title');const imageUpload=document.getElementById('image_upload');const imagePreview=document.getElementById('image-preview');const imageUrlUnchanged=document.getElementById('image_url_unchanged');let allDepartments=[];let editingDepartmentId=null;function showToast(e,t='success'){const o=document.getElementById('toast-container');const a=document.createElement('div');a.classList.add('toast',t);a.textContent=e;o.appendChild(a);setTimeout(()=>{a.remove()},3e3)}imageUpload.addEventListener('change',function(){const e=this.files[0];if(e){const t=new FileReader();t.onload=function(e){imagePreview.src=e.target.result;imageUrlUnchanged.value='false'};t.readAsDataURL(e)}else{imagePreview.src='https://placehold.co/300x200/cccccc/FFFFFF?text=Sin+Imagen';imageUrlUnchanged.value='true'}});function openModal(e){e.style.display='block';setTimeout(()=>e.classList.add('show'),10)}function closeModal(e){e.classList.remove('show');setTimeout(()=>e.style.display='none',300)}closeButtons.forEach(e=>{e.addEventListener('click',()=>{(closeModal(modalPublish),closeModal(modalDetails))})});window.addEventListener('click',e=>{if(e.target===modalPublish){closeModal(modalPublish)}if(e.target===modalDetails){closeModal(modalDetails)}});async function loadDepartments(){try{const e=await fetch(`${API_BASE_URL}${API_ENDPOINT}`);if(!e.ok){throw new Error(`HTTP error! status: ${e.status}`)}allDepartments=await e.json();
// --- CAMBIO: Llamada inicial a filterAndSortDepartments en lugar de displayDepartments ---
filterAndSortDepartments();
// --- FIN CAMBIO ---
}catch(e){console.error('Error al cargar los departamentos:',e);showToast('Error al cargar departamentos.','error')}}function displayDepartments(e){departmentGrid.innerHTML='';if(0===e.length){departmentGrid.innerHTML='<p>No se encontraron departamentos que coincidan con la búsqueda.</p>';return}e.forEach(e=>{const t=document.createElement('div');t.classList.add('department-card');t.innerHTML=`\n            <img src="${e.image_url||'https://placehold.co/300x200/cccccc/FFFFFF?text=Imagen+No+Disponible'}" alt="Imagen del departamento en ${e.location||'Desconocida'}" onerror="this.onerror=null;this.src='https://placehold.co/300x200/cccccc/FFFFFF?text=Error+al+cargar+imagen';" loading="lazy">\n            <h3>${e.title||'Departamento sin título'}</h3>\n            <p><strong>Ubicación:</strong> ${e.location||'Desconocida'}</p>\n            <p><strong>Precio:</strong> $${(e.price||0).toLocaleString('es-AR')}</p>\n            <p><strong>Habitaciones:</strong> ${e.bedrooms||'N/A'}</p>\n            <p><strong>Baños:</strong> ${e.bathrooms||'N/A'}</p>\n            <button class="details-button" data-id="${e.id}">Ver Detalles</button>\n            <button class="edit-button" data-id="${e.id}">Editar</button>\n            <button class="delete-button" data-id="${e.id}">Eliminar</button>\n        `;departmentGrid.appendChild(t)});document.querySelectorAll('.details-button').forEach(t=>{t.addEventListener('click',e=>showDepartmentDetails(e.target.dataset.id))});document.querySelectorAll('.edit-button').forEach(t=>{t.addEventListener('click',e=>editDepartment(e.target.dataset.id))});document.querySelectorAll('.delete-button').forEach(t=>{t.addEventListener('click',e=>deleteDepartment(e.target.dataset.id))})}function showDepartmentDetails(e){const t=allDepartments.find(t=>t.id===e);if(t){document.getElementById('department-title').textContent=t.title||'Detalles del Departamento';document.getElementById('department-image').src=t.image_url||'https://placehold.co/300x200/cccccc/FFFFFF?text=Imagen+No+Disponible';document.getElementById('department-image').alt=`Imagen del departamento en ${t.location||'Desconocida'}`;document.getElementById('department-location').textContent=t.location||'Desconocida';document.getElementById('department-price').textContent=(t.price||0).toLocaleString('es-AR');document.getElementById('department-bedrooms').textContent=t.bedrooms||'N/A';document.getElementById('department-bathrooms').textContent=t.bathrooms||'N/A';document.getElementById('department-description').textContent=t.description||'Sin descripción.';document.getElementById('department-contact').textContent=t.contact||'No especificado.';openModal(modalDetails)}}publishButton.addEventListener('click',()=>{modalPublishTitle.textContent='Publicar Nuevo Departamento';publishForm.reset();imagePreview.src='https://placehold.co/300x200/cccccc/FFFFFF?text=Sin+Imagen';imageUrlUnchanged.value='true';editingDepartmentId=null;openModal(modalPublish)});async function saveDepartment(e){let t=`${API_BASE_URL}${API_ENDPOINT}`;let o='POST';if(editingDepartmentId){t+=`/${editingDepartmentId}`;o='PUT'}try{const a=await fetch(t,{method:o,headers:{'Content-Type':'application/json'},body:JSON.stringify(e)});if(!a.ok){throw new Error(`HTTP error! status: ${a.status}`)}const n=await a.json();showToast(editingDepartmentId?'Departamento actualizado con éxito.':'Departamento publicado con éxito.');closeModal(modalPublish);loadDepartments()}catch(e){console.error('Error al guardar el departamento:',e);showToast('Error al guardar el departamento.','error')}}async function deleteDepartment(e){if(!confirm('¿Estás seguro de que quieres eliminar este departamento?')){return}try{const t=await fetch(`${API_BASE_URL}${API_ENDPOINT}/${e}`,{method:'DELETE'});if(!t.ok){throw new Error(`HTTP error! status: ${t.status}`)}showToast('Departamento eliminado con éxito.','info');loadDepartments()}catch(e){console.error('Error al eliminar el departamento:',e);showToast('Error al eliminar el departamento.','error')}}async function editDepartment(e){const t=allDepartments.find(t=>t.id===e);if(t){modalPublishTitle.textContent='Editar Departamento';document.getElementById('title').value=t.title||'';document.getElementById('location').value=t.location||'';document.getElementById('contact').value=t.contact||'';document.getElementById('price').value=t.price||'';document.getElementById('bedrooms').value=t.bedrooms||'';document.getElementById('bathrooms').value=t.bathrooms||'';document.getElementById('description').value=t.description||'';imagePreview.src=t.image_url||'https://placehold.co/300x200/cccccc/FFFFFF?text=Sin+Imagen';imageUrlUnchanged.value='true';editingDepartmentId=e;openModal(modalPublish)}}
// --- CAMBIO: Renombrada y extendida filterDepartments a filterAndSortDepartments ---
function filterAndSortDepartments(){
// --- INICIO LÓGICA DE FILTRADO (existente) ---
const e=searchInput.value.toLowerCase().trim();const t=parseInt(minBedroomsSelect.value);const o=parseFloat(minPriceInput.value);const a=parseFloat(maxPriceInput.value);let n=allDepartments.filter(n=>{const i=e===''||(n.title&&n.title.toLowerCase().includes(e))||(n.location&&n.location.toLowerCase().includes(e))||(n.description&&n.description.toLowerCase().includes(e));const c=0===t||(n.bedrooms&&n.bedrooms>=t);const d=isNaN(o)||(n.price&&n.price>=o);const s=isNaN(a)||(n.price&&n.price<=a);return i&&c&&d&&s});
// --- FIN LÓGICA DE FILTRADO ---

// --- INICIO LÓGICA DE ORDENAMIENTO (NUEVO) ---
const sortBy=sortBySelect.value;
if (sortBy !== 'none') {
    n.sort((e, t) => {
        let valA, valB;
        if (sortBy.includes('price')) {
            valA = e.price || 0;
            valB = t.price || 0;
        } else if (sortBy.includes('bedrooms')) {
            valA = e.bedrooms || 0;
            valB = t.bedrooms || 0;
        }

        if (sortBy.endsWith('asc')) {
            return valA - valB;
        } else { // desc
            return valB - valA;
        }
    });
}
// --- FIN LÓGICA DE ORDENAMIENTO ---

displayDepartments(n)}
// --- FIN CAMBIO: filterAndSortDepartments ---

// --- CAMBIO: Event Listeners ahora llaman a filterAndSortDepartments ---
searchButton.addEventListener('click',filterAndSortDepartments);searchInput.addEventListener('keyup',e=>{if('Enter'===e.key){filterAndSortDepartments()}});minBedroomsSelect.addEventListener('change',filterAndSortDepartments);minPriceInput.addEventListener('input',filterAndSortDepartments);maxPriceInput.addEventListener('input',filterAndSortDepartments);sortBySelect.addEventListener('change',filterAndSortDepartments); // ¡Nuevo Event Listener para el ordenamiento!
// --- FIN CAMBIO: Event Listeners ---

clearSearchButton.addEventListener('click',()=>{searchInput.value='';minBedroomsSelect.value='0';minPriceInput.value='';maxPriceInput.value='';
// --- CAMBIO: Resetear también el selector de ordenamiento ---
sortBySelect.value='none';
// --- FIN CAMBIO ---
filterAndSortDepartments()});publishForm.addEventListener('submit',async e=>{e.preventDefault();const t=new FormData(publishForm);const o={title:t.get('title'),location:t.get('location'),contact:t.get('contact'),price:parseFloat(t.get('price')),bedrooms:parseInt(t.get('bedrooms')),bathrooms:parseFloat(t.get('bathrooms')),description:t.get('description')};if(!o.title||o.title.trim()===''){showToast('El título es obligatorio.','error');return}if(!o.location||o.location.trim()===''){showToast('La ubicación es obligatoria.','error');return}if(!o.contact||o.contact.trim()===''){showToast('El contacto es obligatorio.','error');return}if(isNaN(o.price)||o.price<=0){showToast('El precio debe ser un número positivo.','error');return}if(isNaN(o.bedrooms)||o.bedrooms<=0||!Number.isInteger(o.bedrooms)){showToast('Las habitaciones deben ser un número entero positivo.','error');return}if(isNaN(o.bathrooms)||o.bathrooms<=0){showToast('Los baños deben ser un número positivo.','error');return}const a=/^[^\s@]+@[^\s@]+\.[^\s@]+$|^[0-9\s\-\(\)\+]{7,}$/;if(!a.test(o.contact)){showToast('Formato de contacto inválido. Ingrese un email o un número de teléfono válido (mín. 7 dígitos).','error');return}if(imageUpload.files.length>0&&'false'===imageUrlUnchanged.value){o.image_url='https://picsum.photos/400/300?'+Math.random()}else if(editingDepartmentId&&'true'===imageUrlUnchanged.value){const e=allDepartments.find(e=>e.id===editingDepartmentId);o.image_url=e?e.image_url:null}else{o.image_url=null}await saveDepartment(o)});document.addEventListener('DOMContentLoaded',loadDepartments);